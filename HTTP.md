Интернет основан на протоколах — системах правил обмена данными между сетевым оборудованием. Более новые протоколы работают на основе более старых, таким образом образовывая многослойный "пирог" и обеспечивая обратную совместимость для всех участников сети.

![](network-layers.png)

> [!NOTE] Способ передачи по HTTP через TLS более известен под названием HTTPS, который рекомендуется как безопасная версия HTTP
# Запросы

HTTP базируется на передаче данных между поставщиком (сервером) и заказчиком (клиентом). Передача данных инициируется от клиента к серверу: клиент отправляет запрос (request), а сервер отправляет ответ (response).

> [!IMPORTANT] Правильно сконфигурированный сервер в начале ответа возвращает один из множества 3-значных кодов, которые сообщают о результате операции:
> 1хх — информационные
> 2хх — успешное завершение
> 3хх — запрос перенаправлен
> 4хх — ошибка клиента
> 5хх — ошибка сервера

Запросы в HTTP содержат необходимые данные:
- адрес
- метод
- заголовок
## Адрес

Адреса стандартизированы и содержат информацию о месте назначения документа или другого объекта в сети. Например, ссылка `http://apalevich.com/media/userpic.jpg` содержит:
- указание на протокол подключения `http`
- указание домена `apalevich.com`, ведущего на сервер
- указание пути на расположение документа на сервере `media/userpic.jpg` 

> [!NOTE] Стандартизованный адрес называется URL и полная форма записи выглядит так: `<схема>:[//[<логин>[:<пароль>]@]<хост>[:<порт>]][/<URL‐путь>][?<параметры>][#<якорь>]`
## Метод

Метод указывает основную операцию над запрашиваевым ресурсом. Обычно метод представляет собой короткое английское слово, записанное заглавными буквами (регистр важен).

- GET — вернуть содержимое ресурса
- HEAD — вернуть только заголовки
- POST — обработать данные из запроса на сервере
- PUT — заменить ресурс содержимым запроса
- PATCH — обновить часть ресурса содержимым запроса
- DELETE — удалить содержимое запроса с сервера
- TRACE — вернуться запрос в качестве ответа
- OPTIONS — отправить список доступных методов 

## Заголовки

Заголовки — это пары `ключ: значение`, которые позволяют отправлять дополнительную информацию вместе с запросом. Они сопровождают как запросы, так и ответы.

Заголовки делятся на 4 группы:
1. Основные заголовки, которые не имеют отношения к содержимому запроса (например, `Date` и `Cache-Control`)
2. Заголовки запроса, посылаемые клиентом (например, `User-Agent` — идентификатор браузера)
3. Заголовки ответа, посылаемые сервером (например, `Last-Modified` и `Content-Type`)
4. Заголовки, описывающие передаваемые данные (например, `Content-Lenght` и `Content-Language`)

Программно не имеет значение, в каком порядке указывать заголовки, но хорошей практикой считается соблюдать по порядку групп.

> [!INFO] Как правило, в голом запросе путь указывается в качестве адреса, а домен — в заголовке `Host`. Но в большинстве интерфейсов это разделение происходит автоматически и указывать `Host` не нужно

# Взаимодействие Клиент—Сервер

HTTP (как и многие другие протоколы на основе TCP) является stateless — то есть по умолчанию Клиент и Сервер ничего не знают о состоянии друга. Это делает протокол простым, быстрым и гибким: сервер знает только, что должен удовлетворять входящие запросы исходя из информации в них.

Используя детали, указанные выше, проиллюстрируем такое взаимодействие.

Итак, сначала инициируем запрос от клиента:
```
GET /axios HTTP/1.1
Host: flaviocopes.com
```

В первой строчке указаны параметры запросы: метод, путь, протокол и его версия.
Со второй строчки идут заголовки заголовки. В данном случае мы используем только один — обязательный Host.

Если мы отправим такой запрос серверу, нам придёт ответ:
```
HTTP/1.1 200 OK
Cache-Control: public, max-age=0
Content-Type: text/html; charset=UTF-8
Date: Sun, 29 Jul 2018 14:20:45 GMT
Age: 152
Content-Lenght: 9797
Server: Netlify

<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>HTTP requests using Axios</title>
...
```

Он похож на запрос, хотя есть отличия.


# Как происходит соединение

В несколько этапов, каждый из которых описанных ниже
## DNS

Интернет использует систему IP-адресов для соединения с серверами (в том числе сайтами). За каждым доменом в URL скрывается IP-адрес, а DNS (Domain Name Server)— это "телефонная книга", которая указывает, какой именно.

Если браузер посещал раньше домен, то его адрес хранится в локальной копии DNS браузера. Если адрес там не найден, то используется `gethostbyname` — специальная POSIX-команда, которая ищет соответствие DNS домена его IP-адресу.

Сначала `gethostbyname` обращается к файлу local hosts на локальной машине. Если там нет нужного значения, происходит запрос в DNS-серверу — предоставленному провайдером или указанном на машине/роутере вручную.

> [!INFO] Запрос к DNS выполняется по протоколу UDP — легковестному connectionless протоколу

Если в кэше указанного DNS сервере не найдено нужное значение, он обращается к корневому (root) DNS серверу. Фактически это не 1, а 13 серверов, распределённых по планете и обеспечивающих работу Интернета.

Root DNS хранит адреса не сайтов, а top-level резолверов — DNS-серверов, хранящих информацию по своей зоне: `.com`, `.ru`, `.tr` и так далее.

Те в свою очередь обращаются к Name Servers (NS), которые предоставляют регистраторы доменов. Они их пополняют новыми адресами, когда кто-то покупает новый домен.

Наконец, полученный IP-адрес возвращается по цепочке наверх, чтобы браузер мог сделать запрос к нужному серверу.
## TCP и UDP

После получения IP-адреса, выполняется подключение – оно может происходить по TCP или UDP.

Transmission Control Protocol (TCP) — это протокол, который устанавливает соединение между отправителем и получателем (handshaking) для передачи пакетов (наборов байтов). Он включает в себя механизм, который гарантирует доставку пакетов, высылает их заново если они теряются, управляет их потоком и очередностью.

Как правило, именно TCP используется для веб-запросов. Однако, HTTP может работать и по UDP.

User Datagram Protocol (UDP) — это протокол, который отправляет пакеты без соединения с получателем и подтверждения получения от него. Как правило, он используется там, где актуальность данных важнее факта их доставки. Например, в стриминге видео, онлайн-играх, IoT.
## Отправка запроса

Запрос — это простой текстовый документ, структурированный определённым образом:

1. Request line (метод, путь, протокол+версия)
2. Request header (построчно расположенные пары `заголовок: значение`)
3. Request  body (не используется в GET-запросах)

Между заголовком и телом запроса должна быть пустая строчка
## Получение ответа

Ответ структурирован похожим образом:

1. Первая строчка ответа содержит код ответа и его название
2. Далее идут заголовки, которые могут отличаться в зависимости от настроек сервера. Есть обязательные, например, Content-Type сообщает клиенту формат входящего файла, а Content-Lenght — его длину в битах.
3. Содержимое, которое браузер обрабатывает

## Обработка результата

*TODO: Добавить ссылку на статью про обработку браузером содержимого ответа  — парсинг, DOM, CSSOM и тд*
# Другие статьи
[WebSocket](WebSocket.md)

# Внешние ресурсы

Обзор HTTP на MDN — https://developer.mozilla.org/en-US/docs/Web/HTTP/Overview
Книга Flavio Copes "Node.js" — https://flaviocopes.com/access/
